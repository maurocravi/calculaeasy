---
interface Props {
    name: string;
    label: string;
    options: [
        { label: string; value: string | number },
        { label: string; value: string | number },
    ];
    selected?: string | number;
}

const { name, label, options, selected } = Astro.props;
const safeSelected = selected ?? options[0].value;
---

<div class="mb-6 binary-toggle-component" data-name={name}>
    <label class="block text-sm font-semibold text-slate-700 mb-2">
        {label}
    </label>
    <div class="relative">
        <!-- Hidden select for form submission and script compatibility -->
        <select name={name} class="hidden">
            {
                options.map((opt) => (
                    <option
                        value={opt.value}
                        selected={opt.value == safeSelected}
                    >
                        {opt.label}
                    </option>
                ))
            }
        </select>

        <!-- Visual Toggle -->
        <div
            class="bg-slate-100 p-1 rounded-xl inline-flex relative w-full sm:w-auto"
        >
            <!-- Sliding background pill -->
            <div
                class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white rounded-lg shadow-sm transition-all duration-200 ease-out transform translate-x-0"
                id={`slider-${name}`}
            >
            </div>

            {
                options.map((opt) => (
                    <button
                        type="button"
                        class={`relative z-10 w-1/2 sm:w-40 px-4 py-3 text-sm font-medium focus:outline-none rounded-lg transition-colors duration-200 cursor-pointer ${
                            opt.value == safeSelected
                                ? "text-slate-900"
                                : "text-slate-500 hover:text-slate-700"
                        }`}
                        data-value={opt.value}
                    >
                        {opt.label}
                    </button>
                ))
            }
        </div>
    </div>
</div>

<script>
    function initBinaryToggles() {
        const components = document.querySelectorAll(
            ".binary-toggle-component",
        );

        components.forEach((component) => {
            const select = component.querySelector(
                "select",
            ) as HTMLSelectElement;
            const buttons = component.querySelectorAll("button");
            const slider = component.querySelector(
                "[id^='slider-']",
            ) as HTMLDivElement;

            if (!select || !buttons.length || !slider) return;

            const updateUI = (value: string) => {
                // Find index of selected value to determine slider position
                // Since it's binary, it's either index 0 (left) or 1 (right)
                // We assume 2 buttons.
                let selectedIndex = 0;
                buttons.forEach((btn, index) => {
                    if (btn.dataset.value == value) {
                        selectedIndex = index;
                    }
                });

                if (selectedIndex === 0) {
                    slider.style.transform = "translateX(0)";
                } else {
                    slider.style.transform = "translateX(100%)";
                }

                // Update Text Colors
                buttons.forEach((btn) => {
                    const btnValue = btn.dataset.value;
                    // Loose comparison for numbers as strings
                    if (btnValue == value) {
                        btn.classList.add("text-slate-900");
                        btn.classList.remove("text-slate-500");
                    } else {
                        btn.classList.remove("text-slate-900");
                        btn.classList.add("text-slate-500");
                    }
                });
            };

            // Handle clicks
            buttons.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const value = btn.dataset.value;
                    if (!value || select.value === value) return;

                    select.value = value;
                    updateUI(value);
                    select.dispatchEvent(
                        new Event("change", { bubbles: true }),
                    );
                });
            });

            // Handle external changes
            select.addEventListener("change", () => {
                updateUI(select.value);
            });

            // Init
            updateUI(select.value);
        });
    }

    initBinaryToggles();
    document.addEventListener("astro:page-load", initBinaryToggles);
</script>
