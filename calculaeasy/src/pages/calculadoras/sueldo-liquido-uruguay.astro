---
import Layout from "../../layouts/Layout.astro";
import CalculatorShell from "../../components/calculators/CalculatorShell.astro";
import InputNumber from "../../components/calculators/InputNumber.astro";
import Select from "../../components/calculators/Select.astro";
import ResultCard from "../../components/calculators/ResultCard.astro";
import RelatedTools from "../../components/RelatedTools.astro";
import ToolContent from "../../components/ToolContent.astro";
import { formatUYU } from "../../lib/calculations/utils";
import { breadcrumbSchema } from "../../lib/seo/breadcrumbSchema";
import Breadcrumbs from "../../components/Breadcrumbs.astro";

const breadcrumbs = [
    { name: "Inicio", url: "https://calculaeasy.com" },
    { name: "Calculadoras", url: "https://calculaeasy.com" },
    {
        name: "Sueldo Líquido",
        url: "https://calculaeasy.com/calculadoras/sueldo-liquido-uruguay",
    },
];

const schema = breadcrumbSchema(breadcrumbs);
---

<Layout
    title="Calcular Sueldo Líquido Uruguay - CalculaEasy"
    description="Calculadora de Sueldo Líquido en Uruguay. Calculá tu salario neto, aportes y descuentos."
    canonical="https://calculaeasy.com/calculadoras/sueldo-liquido-uruguay"
    schema={schema}
>
    <div class="bg-indigo-50 min-h-screen py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
            <Breadcrumbs items={breadcrumbs} />

            <CalculatorShell
                title="Calculadora Sueldo Líquido"
                description="Calculá tu sueldo en mano a partir del nominal. Incluye FONASA, aportes jubilatorios e IRPF."
            >
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                    <!-- Form -->
                    <div>
                        <div class="space-y-6">
                            <InputNumber
                                label="Sueldo Nominal"
                                name="nominal"
                                placeholder="Ej: 50000"
                                min={0}
                            />

                            <Select
                                label="Moneda"
                                name="currency"
                                options={[
                                    {
                                        label: "Pesos Uruguayos ($)",
                                        value: "UYU",
                                    },
                                    { label: "Dólares (U$S)", value: "USD" },
                                ]}
                            />

                            <div id="exchange-rate-container" class="hidden">
                                <InputNumber
                                    label="Cotización Dólar"
                                    name="exchangeRate"
                                    value={40}
                                    min={1}
                                />
                            </div>

                            <Select
                                label="Hijos a cargo (menores/discap)"
                                name="children"
                                options={[
                                    { label: "0", value: 0 },
                                    { label: "1", value: 1 },
                                    { label: "2", value: 2 },
                                    { label: "3+", value: 3 },
                                ]}
                            />

                            <Select
                                label="¿Cónyuge/Concubino sin SNIS?"
                                name="spouseWithoutSNIS"
                                options={[
                                    {
                                        label: "No (Tiene cobertura propia)",
                                        value: 0,
                                    },
                                    { label: "Sí (Sin cobertura)", value: 1 },
                                ]}
                            />
                        </div>
                    </div>

                    <!-- Results -->
                    <div>
                        <ResultCard />

                        <div
                            class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-100 text-sm text-yellow-800"
                        >
                            <strong>Nota:</strong> Este cálculo es una estimación
                            basada en el régimen general dependiente. Puede variar
                            según tu situación específica (cajas paraestatales, régimen
                            ficto, etc).
                        </div>
                    </div>
                </div>
            </CalculatorShell>
            <ToolContent toolId="sueldo-liquido-uruguay" />
            <RelatedTools currentTool="sueldo-liquido-uruguay" />
        </div>
    </div>
</Layout>

<script>
    import { calculateNetSalary } from "../../lib/calculations/uy/salary/netSalary";
    import { IRPF_CONFIG_2025 } from "../../lib/calculations/uy/irpf/tables-2025";
    import { formatUYU } from "../../lib/calculations/utils";

    // Configuration Constants
    // RATES removed here as they are now handled by the calculation modules or config

    const RATES = {
        retirementRate: 0.15,
        frlRate: 0.001,
    };

    // DOM Elements
    const nominalInput = document.querySelector(
        'input[name="nominal"]',
    ) as HTMLInputElement;
    const currencySelect = document.querySelector(
        'select[name="currency"]',
    ) as HTMLSelectElement;
    const exchangeRateInput = document.querySelector(
        'input[name="exchangeRate"]',
    ) as HTMLInputElement;
    const exchangeRateContainer = document.getElementById(
        "exchange-rate-container",
    );
    const childrenSelect = document.querySelector(
        'select[name="children"]',
    ) as HTMLSelectElement;
    const spouseSnisSelect = document.querySelector(
        'select[name="spouseWithoutSNIS"]',
    ) as HTMLSelectElement;

    const resultLiquid = document.getElementById("result-liquid");
    const resultRetirement = document.getElementById("result-retirement");
    const resultFonasa = document.getElementById("result-fonasa");
    const resultFrl = document.getElementById("result-frl");
    const resultIrpf = document.getElementById("result-irpf");
    const resultIrpfGross = document.getElementById("result-irpf-gross");
    const resultIrpfDeductionRate = document.getElementById(
        "result-irpf-deduction-rate",
    );
    const resultIrpfDeductionAmount = document.getElementById(
        "result-irpf-deduction-amount",
    );
    const resultTotalDiscounts = document.getElementById(
        "result-total-discounts",
    );

    function toggleExchangeRate() {
        if (currencySelect.value === "USD") {
            exchangeRateContainer?.classList.remove("hidden");
        } else {
            exchangeRateContainer?.classList.add("hidden");
        }
    }

    // Parse URL params for initial state
    const url = new URL(window.location.href);
    if (url.searchParams.get("children")) {
        // Map simple yes/no from older links or explicit count
        // MVP: if URL says yes, set to 1, if explicit number use it
        const childParam = url.searchParams.get("children");
        if (childParam === "yes") childrenSelect.value = "1";
        else if (!isNaN(Number(childParam)))
            childrenSelect.value = childParam || "0";
    }
    if (url.searchParams.get("spouse")) {
        // Spouse param ignored as "Spouse Charge" is removed.
        // Could map to spouseWithoutSNIS potentially but let's keep it safe.
    }

    function recalculate() {
        const nominal = parseFloat(nominalInput.value) || 0;
        const currency = currencySelect.value as "UYU" | "USD";
        const exchangeRate = parseFloat(exchangeRateInput.value) || 40;
        const childrenCount = parseInt(childrenSelect.value) || 0;
        const spouseWithoutSNIS = parseInt(spouseSnisSelect.value) === 1;
        const hasChildren = childrenCount > 0;

        const result = calculateNetSalary(
            {
                nominalMonthly: nominal,
                currency,
                exchangeRate,
                year: 2025,
                hasChildren,
                spouseWithoutSNIS,
            },
            {
                retirementRate: 0.15,
                frlRate: 0.001,
            },
            IRPF_CONFIG_2025,
        );

        // Update UI
        if (resultLiquid) resultLiquid.innerText = formatUYU(result.netUYU);
        if (resultRetirement)
            resultRetirement.innerText = formatUYU(
                result.contributions.retirement,
            );
        if (resultFonasa)
            resultFonasa.innerText =
                formatUYU(result.contributions.fonasa) +
                ` (${(result.contributions.fonasaRateUsed * 100).toFixed(1)}%)`;
        if (resultFrl)
            resultFrl.innerText = formatUYU(result.contributions.frl);
        if (resultIrpf) resultIrpf.innerText = formatUYU(result.irpf.amount);
        if (resultIrpfGross)
            resultIrpfGross.innerText = formatUYU(result.irpf.gross);
        if (resultIrpfDeductionRate)
            resultIrpfDeductionRate.innerText =
                (result.irpf.generalDeductionRate * 100).toFixed(0) + "%";
        if (resultIrpfDeductionAmount)
            resultIrpfDeductionAmount.innerText =
                "- " + formatUYU(result.irpf.generalDeductionAmount);
        if (resultTotalDiscounts)
            resultTotalDiscounts.innerText =
                "- " + formatUYU(result.totalDiscounts);
    }

    // Event Listeners
    nominalInput?.addEventListener("input", recalculate);
    currencySelect?.addEventListener("change", () => {
        toggleExchangeRate();
        recalculate();
    });
    exchangeRateInput?.addEventListener("input", recalculate);
    childrenSelect?.addEventListener("change", recalculate);
    spouseSnisSelect?.addEventListener("change", recalculate);

    // Initial calculation
    toggleExchangeRate();
    recalculate();
</script>
